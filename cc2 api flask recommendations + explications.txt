
Python

from flask import Flask, request, jsonify
from pymongo import MongoClient
from bson.objectid import ObjectId
import numpy as np
# Autres imports nécessaires (par exemple, pour le traitement des données et la comparaison des embeddings)
# Exemple :
# from sklearn.metrics.pairwise import cosine_similarity

app = Flask(__name__)

# Configuration de la connexion à MongoDB
client = MongoClient('mongodb://localhost:27017/', replicaSet='<nom_du_replica_set>') # Remplacez <nom_du_replica_set> par le nom de votre replica set
db = client.nom_de_la_base_de_donnees # Remplacez nom_de_la_base_de_donnees par le nom de votre base de données

@app.route('/recommendations', methods=['POST'])
def get_recommendations():
    """
    Recommande des films basés sur un embedding donné.
    """
    try:
        # 1. Récupérer l'embedding depuis la requête POST
        data = request.get_json()
        target_embedding = data.get('embedding')

        # Vérifier si l'embedding est fourni
        if not target_embedding:
            return jsonify({'error': 'Embedding is required'}), 400

        target_embedding = np.array(target_embedding) # Convertir la liste en un tableau numpy

        # 2. Récupérer tous les films depuis MongoDB
        movies = list(db.movies.find({}, {'_id': 1, 'embedding': 1}))

        # 3. Comparer l'embedding cible avec les embeddings des films
        # (Vous pouvez utiliser la similarité cosinus ou une autre métrique)
        # similarities = cosine_similarity([target_embedding], [movie['embedding'] for movie in movies])
        # Exemple (remplacer par votre implémentation)
        similarities = [np.dot(target_embedding, movie['embedding']) for movie in movies] # Produit scalaire pour l'exemple

        # 4. Récupérer les films les plus similaires (recommandations)
        # (Trier les films par similarité et récupérer les plus pertinents)
        similar_movies_indices = np.argsort(similarities)[::-1]  # Indices triés par similarité décroissante
        recommended_movies = [movies[i] for i in similar_movies_indices]

        # 5. Récupérer les informations complètes des films recommandés depuis MongoDB
        # (Vous pouvez récupérer les informations complètes en utilisant les IDs des films recommandés)
        # Exemple :
        results = []
        for movie in recommended_movies:
            full_movie_data = db.movies.find_one({'_id': movie['_id']})
            results.append(full_movie_data)

        return jsonify({'recommendations': results}), 200

    except Exception as e:
        return jsonify({'error': str(e)}), 500

if __name__ == '__main__':
    app.run(debug=True)

////////////////////////////////////////////////////////////////////

Explications du code :

    Imports :
        Flask : Pour créer l'API Flask.
        request : Pour gérer les requêtes HTTP.
        jsonify : Pour renvoyer des réponses JSON.
        pymongo : Pour interagir avec MongoDB.
        bson.objectid.ObjectId : Pour gérer les IDs des documents MongoDB.
        numpy : Pour les opérations sur les vecteurs (embeddings).
        Autres imports nécessaires : Vous devrez peut-être ajouter d'autres imports pour le traitement des données et la comparaison des embeddings (par exemple, scikit-learn pour la similarité cosinus).

    Connexion à MongoDB :
        client = MongoClient('mongodb://localhost:27017/', replicaSet='<nom_du_replica_set>') : Établit la connexion à MongoDB en spécifiant l'option replicaSet. Remplacez <nom_du_replica_set> par le nom de votre replica set.
        db = client.nom_de_la_base_de_donnees : Sélectionne la base de données à utiliser. Remplacez nom_de_la_base_de_donnees par le nom de votre base de données.

    Route /recommendations :
        @app.route('/recommendations', methods=['POST']) : Définit la route pour la recommandation de films, accessible via une requête POST.
        def get_recommendations(): : La fonction qui gère la logique de la recommandation.

    Traitement de la requête :
        data = request.get_json() : Récupère les données JSON envoyées dans la requête POST.
        target_embedding = data.get('embedding') : Récupère l'embedding cible depuis les données JSON.
        if not target_embedding: : Vérifie si l'embedding est fourni dans la requête.
        target_embedding = np.array(target_embedding) : Convertit l'embedding (qui est une liste) en un tableau NumPy pour faciliter les calculs.

    Récupération des embeddings depuis MongoDB :
        movies = list(db.movies.find({}, {'_id': 1, 'embedding': 1})) : Récupère les IDs et les embeddings de tous les films depuis la collection movies. Seuls les champs _id et embedding sont récupérés pour optimiser la requête.

    Comparaison des embeddings :
        # similarities = cosine_similarity([target_embedding], [movie['embedding'] for movie in movies]) : Ceci est un exemple d'utilisation de la similarité cosinus (vous devrez peut-être installer scikit-learn). Vous pouvez utiliser d'autres métriques de distance ou de similarité selon vos besoins.
        similarities = [np.dot(target_embedding, movie['embedding']) for movie in movies] : Ceci est un exemple ! Remplacez-le par votre implémentation de la comparaison des embeddings. Cet exemple utilise le produit scalaire.

    Récupération des films recommandés :
        similar_movies_indices = np.argsort(similarities)[::-1] : Trie les indices des films par similarité décroissante.
        recommended_movies = [movies[i] for i in similar_movies_indices] : Récupère les films recommandés en utilisant les indices triés.

    Récupération des informations complètes des films :
        # Exemple : ... : Ce code récupère les informations complètes de chaque film recommandé depuis la base de données en utilisant son _id.

    Retour de la réponse :
        return jsonify({'recommendations': results}), 200 : Renvoie les informations des films recommandés au format JSON avec un code de statut 200 (OK).
        return jsonify({'error': str(e)}), 500 : Gère les exceptions et renvoie un message d'erreur au format JSON avec un code de statut 500 (Erreur interne du serveur).

Points importants à adapter :

    Connexion MongoDB : Remplacez les valeurs d'espace réservé pour l'URL de connexion, le nom du replica set et le nom de la base de données par les valeurs correctes pour votre configuration.
    Comparaison des embeddings : Choisissez une métrique de distance ou de similarité appropriée pour comparer les embeddings. Implémentez le code pour calculer cette métrique.
    Gestion des erreurs : Adaptez la gestion des erreurs selon vos besoins.

Ce code fournit une base pour implémenter la fonctionnalité de recommandation de films basée sur les embeddings. Vous devrez l'adapter en fonction de votre modèle ResNet, de votre configuration MongoDB et de vos exigences spécifiques.